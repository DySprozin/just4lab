?>


<?php

function cutString($string, $maxlen,$id) {
    $len = (mb_strlen($string) > $maxlen)
        ? mb_strripos(mb_substr($string, 0, $maxlen), ' ')
        : $maxlen
    ;
    $cutStr = mb_substr($string, 0, $len);
    return (mb_strlen($string) > $maxlen)
        ? '' . $cutStr . '... <div align="right">  <a href="/kvak/30/' . $id . '/last">Читать далее</a></div>'
        : '' . $cutStr . ' <div align="right">  <a href="/kvak/30/' . $id . '/last">Читать/писать комменты</a></div> '
    ;
}

function kvak_index() {
 $ch = 0;
 $posts = array();
 $idts = array();
 $f = 30;
 $link = mysql_query("SELECT * FROM `topics` WHERE `sticky`='0' AND `topic_status`!='2' AND `forum_id`='30' ORDER BY `topic_last_post_time` DESC");
 while($topic = mysql_fetch_assoc($link)) {
  $idts[] = $topic['topic_id'];
  $t_name[] = $topic['topic_title'];
  $link_post = mysql_query("SELECT * FROM `posts` WHERE `topic_id` = '". $topic['topic_id'] ."' ORDER BY `post_time`");
  $lpost = mysql_fetch_assoc($link_post);
  $posts[] = $lpost['post_text'];
  $posters[] = $lpost['poster_name'];
 }


 $Tidy = new tidy();
 $Tidy_config = array('clean' => true, 'show-body-only' => true); 
 foreach($posts as $id => $post) {
  //$post = strip_tags($post, "<br><div><font><span><b><i><s><a><strong><h1><img>");
  $post = cutString($post, 1500, $idts[$id]);
  $Tidy->parseString($post, $Tidy_config, 'utf8');
  $post = $Tidy;
  echo '<table class="kvak_t">
<tr>
<td>
<div class="blog_tit"></div>
<table style="z-index:1; position: relative;">
<tr><td style="width: 110px;"><img src="/kvak/img/cloud/03.gif" alt=""></td>
<td style="background: #f0f0f0; width:100%;"></td><td><img src="/kvak/img/cloud/05.gif" alt=""></td></tr>
</table>

</td>
</tr>
<tr style="background: #f0f0f0;">
<td>
<div class="blog">
' . $post . '
</div>


</td>
</tr>
<tr>
<td>
<table>
<tr>
<td><img src="/kvak/img/cloud/07.gif" alt=""></td>
<td style="background: #f0f0f0; width:100%;">&nbsp;</td><td style="width: 27px;"><img src="/kvak/img/cloud/09.gif" alt=""></td></tr><tr><td><img src="/kvak/img/cloud/tail.gif" alt=""></td><td colspan="2">&nbsp;</td></tr>
</table>

</td>
</tr>
</table>
&nbsp;&nbsp;&nbsp;&nbsp;<b>' . $posters[$id] . '</b><a><div class="kvak_grad"><a href="/kvak/30/' . $idts[$id] . '/last" class="kvak_grad_link">&nbsp;</a></div>';
 }
}

kvak_index();
?>

